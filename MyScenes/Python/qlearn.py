import random
import pickle

class QLearn:
    def __init__(self, actions, epsilon, alpha, gamma):
        # self.q = {('000', 3): -200, ('001', 2): 1.3688448000000002, ('001', 3): -1, ('011', 0): -200, ('011', 1): 1.439514615462547, ('011', 3): -1, ('013', 2): 1.25088, ('013', 3): -1, ('101', 1): 2.679065244273958, ('102', 0): 10.132161874184142, ('102', 1): -3.0359664320672266, ('110', 2): 4.018539170253948, ('112', 0): 10.065486011535159, ('120', 0): 13.256047836194295, ('120', 3): -1, ('124', 3): -1, ('130', 0): 6.726107313787287, ('134', 3): -1, ('230', 1): 2.377696174702592, ('233', 1): 1, ('234', 2): 1.1280000000000001, ('240', 2): 2.6420461761630785, ('240', 3): -1, ('241', 0): 5.8, ('241', 1): 1.4610560000000001, ('241', 2): -39.072, ('241', 3): -1.0, ('250', 3): -1, ('300', 0): -32.550672559511774, ('300', 1): -51.23436608142651, ('300', 2): -39.773013698064254, ('300', 3): -2.849595821685121, ('301', 0): -8.92648118753527, ('301', 1): -200, ('301', 2): 2.3893151026930846, ('301', 3): -44.46871727363532, ('302', 0): -200, ('302', 1): -96.68494312035226, ('302', 2): -19.74545081537438, ('302', 3): -102.28049089679186, ('310', 0): -34.08158221147085, ('310', 1): -1.305775320192473, ('310', 2): -39.26844389598366, ('310', 3): -40.800000000000004, ('311', 1): 8.227567026246994, ('314', 0): -36.0, ('314', 1): -200, ('314', 2): -39.2, ('314', 3): -1, ('320', 0): 14.925312385666908, ('320', 1): 11.138707541451474, ('320', 2): -36.21489592799109, ('320', 3): 8.006728510058903, ('321', 0): 16.944844712101027, ('323', 2): 8.35278181083769, ('330', 0): 18.47780210506384, ('331', 2): 13.098035032470904, ('332', 1): 5.0763692120618265, ('340', 2): 5.053380411162399, ('341', 0): -29.664930292088222, ('341', 1): 2.0894353108459005, ('341', 2): -32.720265524734934, ('341', 3): 5.68608349286695, ('342', 0): 9.860199119753164, ('343', 1): 1, ('343', 3): -1, ('344', 0): 7.0182813460030244, ('350', 2): 2.1130957917688424, ('352', 0): -200, ('352', 3): -1, ('400', 2): 2.0392642928186104, ('401', 2): 1.1280000000000001, ('402', 1): -39.2, ('403', 0): -34.50145004110211, ('403', 1): -39.63968700946472, ('403', 2): -37.09935918662694, ('403', 3): -37.06611766538929, ('404', 0): -32.9869312, ('404', 1): -200, ('404', 2): 1, ('410', 0): 10.21606333709481, ('411', 1): 7.351022795895854, ('412', 2): 1, ('412', 3): -1, ('414', 2): -38.330691482668115, ('420', 0): 13.61332017096256, ('421', 0): 17.655941044819073, ('421', 1): -34.57059847985121, ('421', 2): 16.389092538053152, ('421', 3): 14.381858531450394, ('422', 0): 21.77882643697856, ('422', 1): -33.77518434125257, ('422', 2): -36.00594750446766, ('422', 3): 7.302517417806977, ('423', 0): 13.531956564032004, ('430', 0): 17.492090457185455, ('431', 2): 11.693750384981687, ('432', 0): 10.783510074080876, ('433', 2): 8.095158928588623, ('434', 1): 6.973022550489537, ('434', 3): -1, ('440', 0): 12.031916319432272, ('440', 1): -31.245876721308342, ('440', 2): 5.798609466036817, ('440', 3): -0.9648565321941334, ('441', 1): 8.841181910913551, ('442', 2): 2.529402254622705, ('450', 0): 7.34862454442251, ('451', 0): 5, ('500', 0): -26.35964187393951, ('500', 1): -34.54361453567722, ('500', 2): 3.014954515723836, ('500', 3): 0.7864370098598382, ('501', 0): 10.108374378873217, ('501', 1): 4.990990110045363, ('501', 2): 5.379916706484224, ('501', 3): -200, ('502', 0): -47.32137281793246, ('502', 1): -94.25069022297237, ('502', 2): -86.91906591515206, ('502', 3): -95.00436147938879, ('503', 0): 3.29226308430124, ('503', 1): -88.18715703939284, ('503', 2): -51.03706879796077, ('503', 3): -53.48655571769582, ('504', 0): 11.130379182490406, ('504', 3): -1, ('510', 0): -2.518527458423832, ('510', 1): 3.9411885781995615, ('510', 2): -34.577323652972446, ('510', 3): -36.9992877429858, ('511', 2): 6.532137278733489, ('512', 1): 6.609611593900218, ('513', 0): 5.89955890502384, ('513', 1): -3.0708318914598416, ('513', 3): -1, ('514', 0): 6.333566975868964, ('514', 1): -36.91811958764138, ('514', 2): 2.2166129056124806, ('514', 3): -200, ('520', 0): 0.8145600327378062, ('520', 1): -5.058870836141194, ('520', 2): 5.938753513587393, ('520', 3): -1, ('521', 0): 21.188675053646296, ('521', 3): -1, ('522', 0): 10.867440177741155, ('522', 1): -200, ('522', 2): 14.126396655066749, ('522', 3): 1.1604462012981211, ('523', 1): 10.888473273456697, ('523', 3): -1, ('530', 2): 6.250554259790082, ('531', 0): 15.536308829846558, ('531', 3): -1, ('532', 1): -6.511575091756469, ('533', 0): 11.747671060882292, ('533', 2): -4.11951048413993, ('534', 1): 9.596662790299929, ('540', 0): -21.920708476711873, ('540', 1): -53.079938021688456, ('540', 2): -5.923181028640416, ('540', 3): -67.44553694529333, ('541', 1): 10.801962498759297, ('541', 3): -1, ('542', 0): 13.352050168258351, ('543', 0): 6.520890539241059, ('544', 0): 7.425258963428173, ('552', 1): 11.142080516929974, ('555', 1): 8.669698272119227, ('555', 3): -1}
        self.q = {}
        try:
            with open('q_table_list.pickle', "rb") as file:
                self.q = pickle.load(file)
        except EOFError:
            pass
        # self.q = {('000', 0): -480.30929932217686,('000', 1): -387.435076545883,('000', 2): -378.1218144476307,('001', 0): -229.37323023570198,('001', 1): -315.52288295166494,('001', 2): -370.0666973242618,('002', 0): -200,('002', 1): -5.362798806861347,('002', 2): -43.73170809184741,('003', 0): 5,('010', 0): -132.8102883731235,('010', 1): -200,('010', 2): -152.44044707406655,('011', 0): -258.274541701405,('011', 1): -273.7940741681088,('011', 2): -174.373730209706,('012', 0): -14.5695750067851,('013', 2): -48.32609520075582,('022', 0): -61.933731428009544,('022', 1): -38.400000000000006,('022', 2): -4.2729919188952055,('033', 0): 8.458545727982479,('033', 1): -38.86165795664843,('033', 2): -3.844653815242098,('100', 0): -286.7428620014482,('100', 1): -295.22416914623506,('100', 2): -298.24157751120526,('101', 0): -199.05699783813154,('101', 1): -227.72126190994126,('101', 2): -231.3765159694882,('110', 0): -179.1321971854356,('110', 1): -154.4356427873884,('110', 2): -161.97387297907167,('111', 0): -66.91498927436416,('111', 1): -125.4458986539559,('111', 2): -7.962984386494287,('112', 0): -50.84729746629281,('112', 1): -64.23731250163057,('112', 2): -94.6882910901771,('113', 0): -30.60221256278941,('113', 1): -31.978372411567335,('113', 2): -35.45221796007109,('120', 2): 1,('121', 0): -14.824964937415668,('121', 1): -15.307249775444719,('121', 2): -11.589178297105825,('122', 0): -19.831016083300828,('122', 1): -121.01992456995043,('122', 2): -26.596317960212097,('123', 0): -7.470179900259689,('123', 1): -5.655592622085818,('123', 2): -13.144397430150278,('133', 0): -27.767388043273836,('133', 1): -33.36483848594608,('133', 2): -35.048132940618316,('200', 0): 5,('200', 2): -49.444213930376236,('201', 0): 2.443092153031169,('202', 2): 1.1600000000000001,('210', 0): -29.307023523493747,('210', 1): 1,('210', 2): -27.185769326069046,('211', 0): -56.53600510929208,('211', 1): -49.32895237573363,('211', 2): -67.01097542298088,('212', 0): -52.525692146769,('212', 1): -57.70599125337494,('212', 2): -60.84789035875854,('213', 0): 6.847334865004312,('220', 1): -4.1855403066847305,('220', 2): 1.0,('221', 0): -12.972160863243566,('221', 1): -16.348852704798883,('221', 2): -14.222638137280859,('222', 0): -3.9940091902585926,('222', 1): -30.79703581059826,('222', 2): -0.03902168474701728,('223', 0): -8.643294845681718,('223', 1): -1.7010367710578245,('223', 2): -11.645008115225453,('231', 0): 5,('232', 2): -0.000801291998785425,('233', 0): 13.869664882185667,('233', 1): -0.43980299545709367,('300', 0): -347.796778467257,('300', 1): -385.38757582191124,('300', 2): -353.4763491785217,('301', 1): 1.3689600095526968,('302', 1): -52.79903462693368,('302', 2): 1,('310', 0): -220.6606532367498,('310', 1): -170.737285013411,('310', 2): -123.63941796772534,('311', 0): -52.43016483839318,('311', 1): -51.968993195884394,('311', 2): -86.56009491660197,('312', 2): 1,('320', 2): 1.3545728936343933,('321', 0): -22.026402031506407,('321', 1): -4.736579385859274,('321', 2): -24.917713027658902,('322', 0): 8.445847844348874,('322', 1): 2.6111364787115168,('322', 2): -26.440351332739368,('323', 0): 14.593823030800937,('323', 2): -1.8259127339225993,('330', 0): 3.6338617284472745,('330', 1): 3.9207214542095743,('330', 2): -200,('331', 0): -32.6577926124733,('331', 1): 1.2221268161978895,('331', 2): -15.840099383981563,('332', 0): 13.771973208399295,('332', 1): -4.171039604171277,('332', 2): -3.129402272351566,('333', 0): 18.116670728308385,('333', 1): -40.64058875530967,('333', 2): -46.26979156957945}
        self.q = {('000', 0): -412.84679287587295,('000', 1): -175.13166796662907,('000', 2): -356.63148875272316,('001', 0): -276.9174974050242,('001', 1): -261.4933060464523,('001', 2): -235.1488473570302,('002', 0): -200,('002', 1): -5.362798806861347,('002', 2): -5.73170809184741,('003', 0): -35.2,('003', 2): -40.058047809097815,('010', 0): -132.8102883731235,('010', 1): -200,('010', 2): -152.44044707406655,('011', 0): -223.39989237390665,('011', 1): -133.35549996127767,('011', 2): -259.0868617083848,('012', 0): -14.5695750067851,('013', 0): 5,('013', 2): -48.32609520075582,('022', 0): -76.05084068602541,('022', 1): -57.05607148451814,('022', 2): -79.82608495760562,('033', 0): 8.458545727982479,('033', 1): -38.86165795664843,('033', 2): -3.844653815242098,('100', 0): -316.34953234009276,('100', 1): -200.29962703425565,('100', 2): -293.07233737395217,('101', 0): -197.68516809325325,('101', 1): -236.80102686603965,('101', 2): -231.3765159694882,('110', 0): -179.1321971854356,('110', 1): -154.4356427873884,('110', 2): -180.5362143347737,('111', 0): -37.09065952399467,('111', 1): -47.19343751425294,('111', 2): -91.69100425373807,('112', 0): -10.351299110717243,('112', 1): -11.798588750563635,('112', 2): -12.6882910901771,('113', 0): -15.547502050110069,('113', 1): -29.92319777889832,('113', 2): -35.45221796007109,('120', 2): 1,('121', 0): -14.824964937415668,('121', 1): -15.307249775444719,('121', 2): -11.589178297105825,('122', 0): -10.390497463704296,('122', 1): -121.01992456995043,('122', 2): -7.937154434990462,('123', 0): -6.883074391541376,('123', 1): -8.404656502262991,('123', 2): -15.943035648298672,('133', 0): 1.2571409694940714,('133', 1): -29.88978134367823,('133', 2): -29.72707277176531,('200', 0): 5,('200', 2): -49.444213930376236,('201', 0): 2.443092153031169,('202', 2): 1.1600000000000001,('210', 0): -29.307023523493747,('210', 1): 1,('210', 2): -27.185769326069046,('211', 0): -38.434769248378245,('211', 1): -15.247206684186443,('211', 2): -35.84166271278577,('212', 0): -45.118135272086946,('212', 1): -25.43328724105363,('212', 2): -32.050553707587355,('213', 0): 6.847334865004312,('220', 1): -4.1855403066847305,('220', 2): 1.0,('221', 0): -12.972160863243566,('221', 1): -16.348852704798883,('221', 2): -8.130190360445754,('222', 0): 6.439699397862866,('222', 1): -30.79703581059826,('222', 2): 3.5095785755855253,('223', 0): -6.270722788099638,('223', 1): -0.1364292364852897,('223', 2): -11.645008115225453,('231', 0): 5,('232', 2): -0.000801291998785425,('233', 0): 14.745513524917339,('233', 1): -0.43980299545709367,('300', 0): -395.3871393544739,('300', 1): -322.50206836550484,('300', 2): -353.4763491785217,('301', 1): 1.3689600095526968,('302', 1): -52.79903462693368,('302', 2): 1,('310', 0): -220.6606532367498,('310', 1): -205.11893779259867,('310', 2): -119.42354010050794,('311', 0): -53.63119822198156,('311', 1): -48.02000125680596,('311', 2): -56.977288424039365,('312', 2): 1,('320', 2): 1.3545728936343933,('321', 0): -22.16221886255945,('321', 1): -17.04782313520619,('321', 2): -24.917713027658902,('322', 0): 6.085020611704229,('322', 1): 5.090948377793583,('322', 2): -26.440351332739368,('323', 0): 9.702269584431296,('323', 2): -1.8259127339225993,('330', 0): -44.47235916485939,('330', 1): -33.38041008255244,('330', 2): -200,('331', 0): -32.6577926124733,('331', 1): -13.748649796010218,('331', 2): -10.446944364108736,('332', 0): 22.062761105312738,('332', 1): -4.171039604171277,('332', 2): -3.129402272351566,('333', 0): 20.164084023011288,('333', 1): -40.64058875530967,('333', 2): -46.26979156957945}


        print('Q\n',self.q)
        self.epsilon = epsilon  # exploration constant
        self.alpha = alpha      # discount constant
        self.gamma = gamma      # discount factor
        self.actions = actions

    def getQ(self, state, action):
        # CHECK WHY DEFAULT VALUE RETURNED WAS 0.0 INSTEAD OF 0, 0.0 is not in if else of choosing action - It is Q value and not action(maybe)
        return self.q.get((state, action), 0)  

    def learnQ(self, state, action, reward, value):
        '''
        Q-learning:
            Q(s, a) += alpha * (reward(s,a) + max(Q(s') - Q(s,a))            
        '''
        oldv = self.q.get((state, action), None)
        if oldv is None:
            self.q[(state, action)] = reward
        else:
            self.q[(state, action)] = oldv + self.alpha * (value - oldv)


    # The problem with this implementation is that if one action becomes too good , that it will always stay better
    def chooseAction(self, state, return_q=False):
        q = [self.getQ(state, a) for a in self.actions]
        maxQ = max(q)

        if random.random() < self.epsilon:
            minQ = min(q); mag = max(abs(minQ), abs(maxQ))
            # add random values to all the actions, recalculate maxQ
            q = [q[i] + random.random() * mag - .5 * mag for i in range(len(self.actions))] 
            maxQ = max(q)

        count = q.count(maxQ)
        # In case there're several state-action max values 
        # we select a random one among them
        if count > 1:
            best = [i for i in range(len(self.actions)) if q[i] == maxQ]
            i = random.choice(best)
        else:
            i = q.index(maxQ)

        action = self.actions[i]        
        if return_q: # if they want it, give it!
            return action, q
        return action

    def learn(self, state1, action1, reward, state2):
        maxqnew = max([self.getQ(state2, a) for a in self.actions])
        self.learnQ(state1, action1, reward, reward + self.gamma*maxqnew)